<!DOCTYPE html>

<html>

<head>

<meta charset="UTF-8">

<title>Insert title here</title>

</head>

<body>

	<canvas id="canvas" width="640" height="640"></canvas>


	<script>
		var canvas = document.getElementById("canvas");

		var ctx = canvas.getContext("2d");

		document.addEventListener('keydown', function(e) {
			switch (e.keyCode) {
			case 87: //w
				bottom_up();
				new_num();
				draw();
				break;
			case 65: //a
				right_left();
				new_num();
				draw();
				break;
			case 83: //s
				top_down();
				new_num();
				draw();
				break;
			case 68: //d
				left_right();
				new_num();
				draw();
				break;
			}

		}, false);

		var arr = {};
		for (var i = 0; i < 4; i++) {
			if (!Array.isArray(arr[i]))
				arr[i] = {};
			for (var j = 0; j < 4; j++) {
				arr[i][j] = {
					n : 0,
					colour : "blue"
				};
			}
		}

		var x;
		var y;
		var r;

		var x2;
		var y2;
		var r2;

		new_num();

		function draw() {
			ctx.fillStyle = "orange";
			ctx.fillRect(0, 0, canvas.width, canvas.height);

			for (var i = 0; i < 4; i++) {
				for (var j = 0; j < 4; j++) {
					ctx.fillStyle = "tomato";
					ctx.fillRect(i * 160 + 5, j * 160 + 5, 160 - 10, 160 - 10);
				}
			}

			var fontsize = 160;

			for (var i = 0; i < 4; i++) {
				for (var j = 0; j < 4; j++) {
					if (arr[j][i].n != 0) {
						var fsize = fontsize;
						if (arr[j][i].n >= 10) {
							fsize /= 2;
						}

						ctx.fillStyle = arr[j][i].colour;
						ctx.font = fsize + "px Verdana";
						ctx.fillText(arr[j][i].n, 160 * i + 25, 160 * j + 140);
						arr[j][i].colour = "black";
					}
				}
			}
		}

		function new_num() {
			var cnt = 0;
			do {
				if (check_over()) {
					return;
				}
				x = Math.floor(Math.random() * 4);
				y = Math.floor(Math.random() * 4);
				r = (Math.floor(Math.random() * 2) + 1) * 2;
				
				cnt++;
				if(cnt>=50){
					return;
				}

			} while (arr[x][y].n != 0);

			do {
				x2 = Math.floor(Math.random() * 4);
				y2 = Math.floor(Math.random() * 4);
				r2 = (Math.floor(Math.random() * 2) + 1) * 2;
			} while (x === x2 && y === y2 && arr[x2][y2].n !== 0);

			arr[x][y].n = r;
			arr[x2][y2].n = r2;
		}

		draw();

		function top_down() {
			for (var i = 0; i < 4; i++) {
				for (var j = 3; j >= 1; j--) {
					if (arr[j][i].n == 0) {
						for (var jj = j - 1; jj >= 0; jj--) {
							if (arr[jj][i].n != 0) {
								arr[j][i].n = arr[jj][i].n;
								arr[jj][i].n = 0;
								arr[jj][i].colour = "blue";
								break;
							}
						}
					}
				}
			}

			for (var i = 0; i < 4; i++) {
				for (var j = 0; j < 3; j++) {
					if (arr[j][i].n == arr[j + 1][i].n) {
						arr[j + 1][i].n = arr[j][i].n + arr[j + 1][i].n;
						arr[j][i].n = 0;
						arr[j][i].colour = "blue";
					}
				}
			}
		}

		function bottom_up() {
			for (var i = 0; i < 4; i++) {
				for (var j = 0; j < 3; j++) {
					if (arr[j][i].n == 0) {
						for (var jj = j + 1; jj < 4; jj++) {
							if (arr[jj][i].n != 0) {
								arr[j][i].n = arr[jj][i].n;
								arr[jj][i].n = 0;
								arr[jj][i].colour = "blue";
								break;
							}
						}
					}
				}
			}

			for (var i = 0; i < 4; i++) {
				for (var j = 3; j >= 1; j--) {
					if (arr[j][i].n == arr[j - 1][i].n) {
						arr[j - 1][i].n = arr[j][i].n + arr[j - 1][i].n;
						arr[j][i].n = 0;
						arr[j][i].colour = "blue";
					}
				}
			}
		}

		function left_right() {
			for (var i = 0; i < 4; i++) {
				for (var j = 3; j >= 1; j--) {
					if (arr[i][j].n == 0) {
						for (var jj = j - 1; jj >= 0; jj--) {
							if (arr[i][jj].n != 0) {
								arr[i][j].n = arr[i][jj].n;
								arr[i][jj].n = 0;
								arr[i][jj].colour = "blue";
								break;
							}
						}
					}
				}
			}

			for (var i = 0; i < 4; i++) {
				for (var j = 0; j < 3; j++) {
					if (arr[i][j].n == arr[i][j + 1].n) {
						arr[i][j + 1].n = arr[i][j].n + arr[i][j + 1].n;
						arr[i][j].n = 0;
						arr[i][j].colour = "blue";
					}
				}
			}
		}

		function right_left() {
			for (var i = 0; i < 4; i++) {
				for (var j = 0; j < 3; j++) {
					if (arr[i][j].n == 0) {
						for (var jj = j + 1; jj < 4; jj++) {
							if (arr[i][jj].n != 0) {
								arr[i][j].n = arr[i][jj].n;
								arr[i][jj].n = 0;
								arr[i][jj].colour = "blue";
								break;
							}
						}
					}
				}
			}

			for (var i = 0; i < 4; i++) {
				for (var j = 3; j >= 1; j--) {
					if (arr[i][j].n == arr[i][j - 1].n) {
						arr[i][j - 1].n = arr[i][j].n + arr[i][j - 1].n;
						arr[i][j].n = 0;
						arr[i][j].colour = "blue";
					}
				}
			}
		}

		function check_over() {
			var check = true;

			for (var i = 0; i < 4; i++) {
				for (var j = 0; j < 3; j++) {
					if (arr[i][j].n == arr[i][j + 1].n) {
						check = false;
					}
				}
			}
			for (var i = 0; i < 4; i++) {
				for (var j = 0; j < 3; j++) {
					if (arr[j][i].n == arr[j + 1][i].n) {
						check = false;
					}
				}
			}
			return check;
		}
	</script>
</body>
</html>